(function(){"use strict";let a;function W(e){const t=typeof e;if(t=="number"||t=="boolean"||e==null)return`${e}`;if(t=="string")return`"${e}"`;if(t=="symbol"){const o=e.description;return o==null?"Symbol":`Symbol(${o})`}if(t=="function"){const o=e.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(e)){const o=e.length;let s="[";o>0&&(s+=W(e[0]));for(let i=1;i<o;i++)s+=", "+W(e[i]);return s+="]",s}const n=/\[object ([^\]]+)\]/.exec(toString.call(e));let r;if(n&&n.length>1)r=n[1];else return toString.call(e);if(r=="Object")try{return"Object("+JSON.stringify(e)+")"}catch{return"Object"}return e instanceof Error?`${e.name}: ${e.message}
${e.stack}`:r}function z(e,t){return e=e>>>0,p().subarray(e/1,e/1+t)}let l=null;function _(){return(l===null||l.buffer.detached===!0||l.buffer.detached===void 0&&l.buffer!==a.memory.buffer)&&(l=new DataView(a.memory.buffer)),l}function S(e,t){return e=e>>>0,v(e,t)}let h=null;function p(){return(h===null||h.byteLength===0)&&(h=new Uint8Array(a.memory.buffer)),h}function x(e){return e==null}function A(e,t,n){if(n===void 0){const c=M.encode(e),f=t(c.length,1)>>>0;return p().subarray(f,f+c.length).set(c),w=c.length,f}let r=e.length,o=t(r,1)>>>0;const s=p();let i=0;for(;i<r;i++){const c=e.charCodeAt(i);if(c>127)break;s[o+i]=c}if(i!==r){i!==0&&(e=e.slice(i)),o=n(o,r,r=i+e.length*3,1)>>>0;const c=p().subarray(o+i,o+r),f=M.encodeInto(e,c);i+=f.written,o=n(o,r,i,1)>>>0}return w=i,o}function I(e){const t=a.__wbindgen_externrefs.get(e);return a.__externref_table_dealloc(e),t}let E=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});E.decode();const P=2146435072;let F=0;function v(e,t){return F+=t,F>=P&&(E=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),E.decode(),F=t),E.decode(p().subarray(e,e+t))}const M=new TextEncoder;"encodeInto"in M||(M.encodeInto=function(e,t){const n=M.encode(e);return t.set(n),{read:e.length,written:n.length}});let w=0;function B(e,t,n){const r=a.compute_trajectory(e,t,n);if(r[2])throw I(r[1]);return I(r[0])}const C=new Set(["basic","cors","default"]);async function L(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.ok&&C.has(e.type)&&e.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function Y(){const e={};return e.wbg={},e.wbg.__wbg_Error_52673b7de5a0ca89=function(t,n){return Error(S(t,n))},e.wbg.__wbg_String_8f0eb39a4a4c2f66=function(t,n){const r=String(n),o=A(r,a.__wbindgen_malloc,a.__wbindgen_realloc),s=w;_().setInt32(t+4*1,s,!0),_().setInt32(t+4*0,o,!0)},e.wbg.__wbg___wbindgen_boolean_get_dea25b33882b895b=function(t){const n=t,r=typeof n=="boolean"?n:void 0;return x(r)?16777215:r?1:0},e.wbg.__wbg___wbindgen_debug_string_adfb662ae34724b6=function(t,n){const r=W(n),o=A(r,a.__wbindgen_malloc,a.__wbindgen_realloc),s=w;_().setInt32(t+4*1,s,!0),_().setInt32(t+4*0,o,!0)},e.wbg.__wbg___wbindgen_in_0d3e1e8f0c669317=function(t,n){return t in n},e.wbg.__wbg___wbindgen_is_object_ce774f3490692386=function(t){const n=t;return typeof n=="object"&&n!==null},e.wbg.__wbg___wbindgen_is_string_704ef9c8fc131030=function(t){return typeof t=="string"},e.wbg.__wbg___wbindgen_is_undefined_f6b95eab589e0269=function(t){return t===void 0},e.wbg.__wbg___wbindgen_jsval_loose_eq_766057600fdd1b0d=function(t,n){return t==n},e.wbg.__wbg___wbindgen_number_get_9619185a74197f95=function(t,n){const r=n,o=typeof r=="number"?r:void 0;_().setFloat64(t+8*1,x(o)?0:o,!0),_().setInt32(t+4*0,!x(o),!0)},e.wbg.__wbg___wbindgen_string_get_a2a31e16edf96e42=function(t,n){const r=n,o=typeof r=="string"?r:void 0;var s=x(o)?0:A(o,a.__wbindgen_malloc,a.__wbindgen_realloc),i=w;_().setInt32(t+4*1,i,!0),_().setInt32(t+4*0,s,!0)},e.wbg.__wbg___wbindgen_throw_dd24417ed36fc46e=function(t,n){throw new Error(S(t,n))},e.wbg.__wbg_entries_83c79938054e065f=function(t){return Object.entries(t)},e.wbg.__wbg_error_7534b8e9a36f1ab4=function(t,n){let r,o;try{r=t,o=n,console.error(S(t,n))}finally{a.__wbindgen_free(r,o,1)}},e.wbg.__wbg_get_6b7bd52aca3f9671=function(t,n){return t[n>>>0]},e.wbg.__wbg_get_with_ref_key_1dc361bd10053bfe=function(t,n){return t[n]},e.wbg.__wbg_instanceof_ArrayBuffer_f3320d2419cd0355=function(t){let n;try{n=t instanceof ArrayBuffer}catch{n=!1}return n},e.wbg.__wbg_instanceof_Uint8Array_da54ccc9d3e09434=function(t){let n;try{n=t instanceof Uint8Array}catch{n=!1}return n},e.wbg.__wbg_length_22ac23eaec9d8053=function(t){return t.length},e.wbg.__wbg_length_d45040a40c570362=function(t){return t.length},e.wbg.__wbg_new_1ba21ce319a06297=function(){return new Object},e.wbg.__wbg_new_25f239778d6112b9=function(){return new Array},e.wbg.__wbg_new_6421f6084cc5bc5a=function(t){return new Uint8Array(t)},e.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},e.wbg.__wbg_prototypesetcall_dfe9b766cdc1f1fd=function(t,n,r){Uint8Array.prototype.set.call(z(t,n),r)},e.wbg.__wbg_set_3f1d0b984ed272ed=function(t,n,r){t[n]=r},e.wbg.__wbg_set_7df433eea03a5c14=function(t,n,r){t[n>>>0]=r},e.wbg.__wbg_stack_0ed75d68575b0f3c=function(t,n){const r=n.stack,o=A(r,a.__wbindgen_malloc,a.__wbindgen_realloc),s=w;_().setInt32(t+4*1,s,!0),_().setInt32(t+4*0,o,!0)},e.wbg.__wbindgen_cast_2241b6af4c4b2941=function(t,n){return S(t,n)},e.wbg.__wbindgen_cast_d6cd19b81560fd6e=function(t){return t},e.wbg.__wbindgen_init_externref_table=function(){const t=a.__wbindgen_externrefs,n=t.grow(4);t.set(0,void 0),t.set(n+0,void 0),t.set(n+1,null),t.set(n+2,!0),t.set(n+3,!1)},e}function N(e,t){return a=e.exports,k.__wbindgen_wasm_module=t,l=null,h=null,a.__wbindgen_start(),a}async function k(e){if(a!==void 0)return a;typeof e<"u"&&(Object.getPrototypeOf(e)===Object.prototype?{module_or_path:e}=e:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof e>"u"&&(e=new URL("/OpenWEZ/assets/wasm_ballistics_bg-FYdTQFkC.wasm",self.location.href));const t=Y();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:r}=await L(await e,t);return N(n,r)}function g(e,t){const n=Math.random(),r=Math.random();return Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*r)*t+e}let j=!1;self.onmessage=async e=>{const{type:t,payload:n}=e.data;if(t==="RUN_SIMULATION")try{j||(console.log("[Worker] Initializing WASM..."),await k(),j=!0,console.log("[Worker] WASM initialized successfully"));const{baseInputs:r,config:o}=n,s=await X(r,o);self.postMessage({type:"SIMULATION_COMPLETE",payload:s})}catch(r){console.error("[Worker] Simulation error:",r),self.postMessage({type:"SIMULATION_ERROR",payload:r instanceof Error?r.message:"Simulation failed"})}};async function X(e,t){const n=performance.now(),r=[],o=[],{iterations:s,uncertainties:i,target:c,maxRange:f,rangeStep:y}=t;console.log(`[Worker] Running ${s} iterations at ${f} yards...`);for(let b=0;b<s;b++){const G=V(e,i),T=B(G,f,y);T&&T.length>0&&T.forEach(m=>{o.push({x:m.drift,y:m.drop,range:m.range});const J=q(m.range,m.drift,m.drop,i.meanRadiusMOA);r.push(J)}),((b+1)%100===0||b===s-1)&&self.postMessage({type:"PROGRESS_UPDATE",payload:{completed:b+1,total:s,percentage:(b+1)/s*100}})}console.log(`[Worker] Completed ${s} iterations`);const R=r.filter(b=>Math.abs(b.range-f)<y/2),D=o.filter(b=>Math.abs(b.range-f)<y/2),u=U(R),d=U(D),O=H(r,c,y),$=performance.now()-n;return console.log(`[Worker] Computation time: ${$.toFixed(2)}ms`),console.log(`[Worker] P(hit) data points: ${Object.keys(O).length}`),console.log(`[Worker] Total dispersion std dev: X=${u.standardDeviation.x.toFixed(2)}", Y=${u.standardDeviation.y.toFixed(2)}"`),console.log(`[Worker] Ballistic-only std dev: X=${d.standardDeviation.x.toFixed(2)}", Y=${d.standardDeviation.y.toFixed(2)}"`),{impactPoints:R,ballisticImpactPoints:D,pHitByRange:O,statistics:u,statisticsBallisticOnly:d,computationTime:$}}function V(e,t){const n=e.bc.value*(t.bcSD/100);return{...e,muzzleVelocity:g(e.muzzleVelocity,t.muzzleVelocitySD),bc:{...e.bc,value:Math.max(.001,g(e.bc.value,n))},environment:{...e.environment,windSpeed:Math.max(0,e.environment.windSpeed+g(0,t.windSpeedSD)),windDirection:e.environment.windDirection+g(0,t.windDirectionSD)},zeroRange:g(e.zeroRange,t.rangeErrorSD)}}function q(e,t,n,r){const s=r*(e/100)*1.047/1.253,i=t+g(0,s),c=n+g(0,s);return{x:i,y:c,range:e}}function U(e){const t=e.length;if(t===0)return{mean:{x:0,y:0},standardDeviation:{x:0,y:0}};const n=e.reduce((i,c)=>i+c.x,0)/t,r=e.reduce((i,c)=>i+c.y,0)/t,o=e.reduce((i,c)=>i+Math.pow(c.x-n,2),0)/t,s=e.reduce((i,c)=>i+Math.pow(c.y-r,2),0)/t;return{mean:{x:n,y:r},standardDeviation:{x:Math.sqrt(o),y:Math.sqrt(s)}}}function H(e,t,n){const r={},o=t.width/2,s=t.height/2,i=new Map;return e.forEach(c=>{const f=Math.round(c.range/n)*n;i.has(f)||i.set(f,[]),i.get(f).push(c)}),i.forEach((c,f)=>{const y=c.reduce((u,d)=>u+d.x,0)/c.length,R=c.reduce((u,d)=>u+d.y,0)/c.length,D=c.filter(u=>{const d=u.x-y,O=u.y-R;return Math.abs(d)<=o&&Math.abs(O)<=s}).length;r[f]=D/c.length}),r}})();
